<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Baby Gender Guess üçº</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&family=Sacramento&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --blue: #7BAFD4; --blue-light: #B8D8EE; --blue-dark: #4A86B8;
    --pink: #E8879C; --pink-light: #F5C4CF; --pink-dark: #C9566D;
    --cream: #FDF8F4; --text: #3A3035;
    --gold: #D4A574; --gold-light: #E8CDB0;
  }
  body {
    min-height: 100vh;
    background-color: var(--cream);
    background-image:
      radial-gradient(circle at 15% 20%, rgba(184,216,238,0.35) 0%, transparent 40%),
      radial-gradient(circle at 85% 80%, rgba(245,196,207,0.35) 0%, transparent 40%),
      radial-gradient(circle at 50% 50%, rgba(212,165,116,0.08) 0%, transparent 60%);
    font-family: 'Lato', sans-serif;
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
  }
  .card {
    background: white;
    border-radius: 2rem;
    padding: 3rem 3.5rem;
    max-width: 520px;
    width: 100%;
    box-shadow: 0 8px 48px rgba(0,0,0,0.07), 0 2px 12px rgba(0,0,0,0.04);
    text-align: center;
    animation: rise 0.7s cubic-bezier(0.22,1,0.36,1) both;
    position: relative;
    overflow: hidden;
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--blue-light), var(--pink-light), var(--gold-light));
  }
  @keyframes rise { from { opacity:0; transform:translateY(28px); } to { opacity:1; transform:translateY(0); } }
  @keyframes fadeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
  @keyframes shimmer {
    0% { background-position: -200% center; }
    100% { background-position: 200% center; }
  }
  .emoji { font-size: 3rem; margin-bottom: 1rem; display: block; }
  h1 { font-family: 'Playfair Display', serif; font-size: 2.1rem; font-weight: 700; line-height: 1.2; margin-bottom: 0.4rem; }
  .subtitle { font-size: 1rem; font-weight: 300; color: #888; margin-bottom: 2.5rem; letter-spacing: 0.02em; }

  /* Name Input Step */
  .step { display: none; }
  .step.active { display: block; animation: fadeIn 0.5s cubic-bezier(0.22,1,0.36,1) both; }

  .name-input-wrap {
    position: relative;
    margin-bottom: 1.5rem;
  }
  .name-input {
    width: 100%;
    border: 2px solid #ece8e3;
    border-radius: 1rem;
    padding: 1rem 1.2rem;
    font-family: 'Lato', sans-serif;
    font-size: 1.1rem;
    font-weight: 400;
    color: var(--text);
    background: #faf8f6;
    outline: none;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    text-align: center;
  }
  .name-input::placeholder { color: #c4bfb8; font-weight: 300; }
  .name-input:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 4px rgba(212,165,116,0.12);
    background: white;
  }
  .btn-continue {
    border: none;
    border-radius: 1rem;
    padding: 0.9rem 2.5rem;
    font-family: 'Lato', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    cursor: pointer;
    color: white;
    background: linear-gradient(145deg, var(--gold-light), var(--gold));
    box-shadow: 0 4px 16px rgba(212,165,116,0.3);
    transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.2s ease;
  }
  .btn-continue:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(212,165,116,0.4); }
  .btn-continue:active { transform: translateY(0); }
  .btn-continue:disabled { opacity: 0.5; cursor: default; transform: none; }

  /* Voting Step */
  .greeting { font-family: 'Sacramento', cursive; font-size: 1.6rem; color: var(--gold); margin-bottom: 1.8rem; }
  .choices { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; margin-bottom: 2rem; }
  .btn {
    border: none; border-radius: 1.25rem; padding: 1.8rem 1rem;
    font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 700;
    cursor: pointer;
    display: flex; flex-direction: column; align-items: center; gap: 0.5rem;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    color: white;
  }
  .btn:hover { transform: translateY(-4px); }
  .btn:active { transform: translateY(0); }
  .btn:disabled { cursor: default; transform: none; }
  .btn .btn-emoji { font-size: 2.2rem; }
  .btn-boy { background: linear-gradient(145deg, var(--blue-light), var(--blue)); box-shadow: 0 6px 24px rgba(75,134,184,0.3); }
  .btn-boy:hover { box-shadow: 0 12px 36px rgba(74,134,184,0.45); }
  .btn-girl { background: linear-gradient(145deg, var(--pink-light), var(--pink)); box-shadow: 0 6px 24px rgba(201,86,109,0.25); }
  .btn-girl:hover { box-shadow: 0 12px 36px rgba(201,86,109,0.38); }

  /* Results */
  .results { display: none; animation: rise 0.5s cubic-bezier(0.22,1,0.36,1) both; }
  .results.show { display: block; }
  .result-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
  .result-label { font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 700; width: 48px; text-align: right; flex-shrink: 0; }
  .bar-wrap { flex: 1; background: #F0EDE9; border-radius: 99px; height: 14px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 99px; transition: width 1s cubic-bezier(0.22,1,0.36,1); width: 0%; }
  .bar-boy  { background: linear-gradient(90deg, var(--blue-light), var(--blue)); }
  .bar-girl { background: linear-gradient(90deg, var(--pink-light), var(--pink)); }
  .result-pct { font-weight: 700; font-size: 0.95rem; width: 40px; text-align: left; flex-shrink: 0; }
  .tally-note { font-size: 0.82rem; font-weight: 300; color: #aaa; margin-top: 0.5rem; }
  .voted-badge {
    display: inline-block; background: #f4f1ee; border-radius: 99px;
    padding: 0.35rem 1rem; font-size: 0.8rem; color: #999;
    margin-bottom: 1.5rem; letter-spacing: 0.04em;
  }

  /* Voter Scroll List */
  .voters-section {
    display: none;
    margin-top: 2rem;
    max-width: 520px;
    width: 100%;
    animation: fadeIn 0.6s cubic-bezier(0.22,1,0.36,1) both;
    animation-delay: 0.4s;
  }
  .voters-section.show { display: block; }
  .voters-header {
    font-family: 'Playfair Display', serif;
    font-size: 1.15rem;
    font-weight: 700;
    margin-bottom: 1rem;
    text-align: center;
    color: var(--text);
  }
  .voters-header span { font-weight: 300; color: #aaa; font-family: 'Lato', sans-serif; font-size: 0.85rem; }
  .voters-list {
    background: white;
    border-radius: 1.5rem;
    box-shadow: 0 4px 32px rgba(0,0,0,0.05), 0 1px 8px rgba(0,0,0,0.03);
    max-height: 320px;
    overflow-y: auto;
    padding: 0.5rem 0;
    scrollbar-width: thin;
    scrollbar-color: #e0dcd7 transparent;
  }
  .voters-list::-webkit-scrollbar { width: 6px; }
  .voters-list::-webkit-scrollbar-track { background: transparent; }
  .voters-list::-webkit-scrollbar-thumb { background: #e0dcd7; border-radius: 99px; }
  .voter-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    gap: 0.85rem;
    transition: background 0.2s ease;
    animation: fadeIn 0.4s ease both;
  }
  .voter-item:hover { background: #faf8f6; }
  .voter-item + .voter-item { border-top: 1px solid #f4f1ee; }
  .voter-avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
    color: white;
    font-weight: 700;
    font-family: 'Playfair Display', serif;
    font-size: 0.85rem;
  }
  .voter-avatar.boy { background: linear-gradient(145deg, var(--blue-light), var(--blue)); }
  .voter-avatar.girl { background: linear-gradient(145deg, var(--pink-light), var(--pink)); }
  .voter-name {
    flex: 1;
    font-weight: 400;
    font-size: 0.95rem;
    color: var(--text);
    text-align: left;
  }
  .voter-choice {
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    padding: 0.2rem 0.7rem;
    border-radius: 99px;
  }
  .voter-choice.boy { color: var(--blue-dark); background: rgba(123,175,212,0.12); }
  .voter-choice.girl { color: var(--pink-dark); background: rgba(232,135,156,0.12); }
  .voter-time {
    font-size: 0.72rem;
    color: #c4bfb8;
    font-weight: 300;
    flex-shrink: 0;
  }
  .empty-voters {
    padding: 2rem;
    text-align: center;
    color: #c4bfb8;
    font-weight: 300;
    font-size: 0.9rem;
  }

  @media (max-width: 560px) {
    body { padding: 1rem; }
    .card { padding: 2rem 1.5rem; }
    h1 { font-size: 1.7rem; }
    .btn { padding: 1.4rem 0.8rem; font-size: 1.2rem; }
    .voters-list { max-height: 260px; }
    .voter-item { padding: 0.65rem 1rem; }
  }
</style>
</head>
<body>

<div class="card">
  <span class="emoji">üçº</span>
  <h1>Boy or Girl?</h1>
  <p class="subtitle">Cast your vote ‚Äî we'll reveal the results soon!</p>

  <!-- Step 1: Name -->
  <div class="step active" id="step-name">
    <div class="name-input-wrap">
      <input type="text" class="name-input" id="name-input" placeholder="Enter your name" maxlength="40" autocomplete="off">
    </div>
    <button class="btn-continue" id="btn-continue" disabled onclick="submitName()">Continue</button>
  </div>

  <!-- Step 2: Vote -->
  <div class="step" id="step-vote">
    <p class="greeting" id="greeting"></p>
    <div class="choices" id="choices">
      <button class="btn btn-boy" onclick="vote('boy')">
        <span class="btn-emoji">üë¶</span> Boy
      </button>
      <button class="btn btn-girl" onclick="vote('girl')">
        <span class="btn-emoji">üëß</span> Girl
      </button>
    </div>
  </div>

  <!-- Results -->
  <div class="results" id="results">
    <div class="voted-badge" id="voted-badge"></div>
    <div class="result-row">
      <span class="result-label" style="color:var(--blue-dark)">Boy</span>
      <div class="bar-wrap"><div class="bar-fill bar-boy" id="bar-boy"></div></div>
      <span class="result-pct" id="pct-boy">0%</span>
    </div>
    <div class="result-row">
      <span class="result-label" style="color:var(--pink-dark)">Girl</span>
      <div class="bar-wrap"><div class="bar-fill bar-girl" id="bar-girl"></div></div>
      <span class="result-pct" id="pct-girl">0%</span>
    </div>
    <p class="tally-note" id="tally-note"></p>
  </div>
</div>

<!-- Voter List -->
<div class="voters-section" id="voters-section">
  <p class="voters-header">Everyone's Guesses <span id="voter-count"></span></p>
  <div class="voters-list" id="voters-list">
    <div class="empty-voters">No votes yet ‚Äî be the first!</div>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://rzounkywhxriavkswotm.supabase.co";
  const SUPABASE_KEY = "sb_publishable_GGNfWZXJafHbroc8uPN0_Q_ZlXt8KQo";
  const VOTED_KEY = "baby-gender-my-vote-v2";
  const NAME_KEY  = "baby-gender-my-name-v2";

  let userName = '';

  // ‚îÄ‚îÄ Name Step ‚îÄ‚îÄ
  const nameInput = document.getElementById('name-input');
  const btnContinue = document.getElementById('btn-continue');

  nameInput.addEventListener('input', () => {
    btnContinue.disabled = nameInput.value.trim().length === 0;
  });
  nameInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && nameInput.value.trim()) submitName();
  });

  function submitName() {
    userName = nameInput.value.trim();
    if (!userName) return;
    localStorage.setItem(NAME_KEY, userName);
    document.getElementById('step-name').classList.remove('active');
    document.getElementById('step-vote').classList.add('active');
    document.getElementById('greeting').textContent = `Hi ${userName}, what's your guess?`;
  }

  // ‚îÄ‚îÄ Supabase Helpers ‚îÄ‚îÄ
  async function fetchVoters() {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/voters?select=name,choice,created_at&order=created_at.desc`, {
      headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
    });
    return await res.json();
  }

  async function insertVoter(name, choice) {
    await fetch(`${SUPABASE_URL}/rest/v1/voters`, {
      method: "POST",
      headers: {
        "apikey": SUPABASE_KEY,
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json",
        "Prefer": "return=minimal"
      },
      body: JSON.stringify({ name, choice })
    });
  }

  // ‚îÄ‚îÄ Voting ‚îÄ‚îÄ
  async function vote(choice) {
    if (localStorage.getItem(VOTED_KEY)) return;
    localStorage.setItem(VOTED_KEY, choice);
    document.querySelectorAll('.btn').forEach(b => b.disabled = true);

    try {
      await insertVoter(userName, choice);
    } catch(e) {
      console.error('Vote insert failed:', e);
    }

    const voters = await fetchVoters();
    showResults(choice, voters);
    showVoters(voters);
  }

  // ‚îÄ‚îÄ Display Results ‚îÄ‚îÄ
  function showResults(choice, voters) {
    const boyCount  = voters.filter(v => v.choice === 'boy').length;
    const girlCount = voters.filter(v => v.choice === 'girl').length;
    const total = boyCount + girlCount;
    const boyPct  = total ? Math.round((boyCount / total) * 100) : 0;
    const girlPct = total ? 100 - boyPct : 0;

    document.getElementById('step-vote').classList.remove('active');
    document.getElementById('voted-badge').textContent =
      `You voted: ${choice.charAt(0).toUpperCase() + choice.slice(1)} ‚úì`;
    document.getElementById('pct-boy').textContent  = boyPct + '%';
    document.getElementById('pct-girl').textContent = girlPct + '%';
    document.getElementById('tally-note').textContent =
      `${total} vote${total === 1 ? '' : 's'} total`;

    document.getElementById('results').classList.add('show');

    setTimeout(() => {
      document.getElementById('bar-boy').style.width  = boyPct + '%';
      document.getElementById('bar-girl').style.width = girlPct + '%';
    }, 100);
  }

  // ‚îÄ‚îÄ Display Voter List ‚îÄ‚îÄ
  function showVoters(voters) {
    const section = document.getElementById('voters-section');
    const list = document.getElementById('voters-list');
    const countEl = document.getElementById('voter-count');

    section.classList.add('show');
    countEl.textContent = `¬∑ ${voters.length} total`;

    if (voters.length === 0) {
      list.innerHTML = '<div class="empty-voters">No votes yet ‚Äî be the first!</div>';
      return;
    }

    list.innerHTML = voters.map((v, i) => {
      const initials = v.name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
      const timeAgo = getTimeAgo(v.created_at);
      return `
        <div class="voter-item" style="animation-delay: ${i * 0.06}s">
          <div class="voter-avatar ${v.choice}">${initials}</div>
          <span class="voter-name">${escapeHtml(v.name)}</span>
          <span class="voter-choice ${v.choice}">${v.choice === 'boy' ? 'üë¶ Boy' : 'üëß Girl'}</span>
          <span class="voter-time">${timeAgo}</span>
        </div>
      `;
    }).join('');
  }

  function getTimeAgo(dateStr) {
    const now = new Date();
    const then = new Date(dateStr);
    const diff = Math.floor((now - then) / 1000);
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
  }

  function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  // ‚îÄ‚îÄ On Load: Restore State ‚îÄ‚îÄ
  window.addEventListener('DOMContentLoaded', async () => {
    // Clear old v1 keys from previous version of the app
    localStorage.removeItem('baby-gender-my-vote-v1');

    const priorName = localStorage.getItem(NAME_KEY);
    const priorVote = localStorage.getItem(VOTED_KEY);

    if (priorName && priorVote) {
      // Already voted ‚Äî skip straight to results
      userName = priorName;
      document.getElementById('step-name').classList.remove('active');
      // Hide vote buttons entirely
      document.getElementById('step-vote').classList.remove('active');
      document.querySelectorAll('.btn').forEach(b => b.disabled = true);

      try {
        const voters = await fetchVoters();
        showResults(priorVote, voters);
        showVoters(voters);
      } catch(e) {
        console.error('Failed to load voters:', e);
        showResults(priorVote, []);
      }
    } else if (priorName) {
      // Has name but hasn't voted yet ‚Äî go to vote step
      userName = priorName;
      document.getElementById('step-name').classList.remove('active');
      document.getElementById('step-vote').classList.add('active');
      document.getElementById('greeting').textContent = `Hi ${userName}, what's your guess?`;
    }
    // Otherwise: fresh user, step-name is already active
  });
</script>
</body>
</html>
